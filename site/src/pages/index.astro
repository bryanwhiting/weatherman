---
import runs from '../data/forecast-index.json';
import { execSync } from 'node:child_process';
import MainLayout from '../layouts/MainLayout.astro';

const forecastModules = import.meta.glob('../data/forecasts/*.json', { eager: true });
const allBacktests = Object.values(forecastModules)
  .map((mod: any) => mod.default ?? mod)
  .flatMap((data: any) => data.backtest ?? []);

const leaderboardMap = new Map<string, { total: number; count: number }>();
for (const row of allBacktests) {
  const model = row.model;
  const smape = Number(row.smape);
  if (!model || Number.isNaN(smape)) continue;
  const current = leaderboardMap.get(model) ?? { total: 0, count: 0 };
  leaderboardMap.set(model, { total: current.total + smape, count: current.count + 1 });
}

const leaderboard = Array.from(leaderboardMap.entries())
  .map(([model, stats]) => ({ model, avgSmape: stats.total / stats.count, samples: stats.count }))
  .sort((a, b) => a.avgSmape - b.avgSmape);

const gitHash = (() => {
  try { return execSync('git rev-parse --short HEAD').toString().trim(); } catch { return 'nogit'; }
})();
const d = new Date();
const version = `v0.${String(d.getUTCFullYear()).slice(-2)}${String(d.getUTCMonth()+1).padStart(2,'0')}${String(d.getUTCDate()).padStart(2,'0')}${String(d.getUTCHours()).padStart(2,'0')}${String(d.getUTCMinutes()).padStart(2,'0')}${String(d.getUTCSeconds()).padStart(2,'0')}-${gitHash}`;

const defaultPayload = JSON.stringify({
  start_datetime: '2026-01-01T17:15:00',
  granularity: '1h',
  horizon: 24,
  model: 'nixtla',
  run_name_root: 'my-forecast-run',
  n_series: 2,
  backtest_windows: 3,
  series_names: ['demo_hourly_1', 'demo_hourly_2'],
  series: [
    [100, 102, 99, 101, 103, 104, 106, 108, 110, 111, 113, 116],
    [80, 82, 81, 83, 86, 88, 87, 89, 91, 94, 96, 97]
  ],
}, null, 2);
---
<MainLayout title="Weatherman">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex items-center gap-2">
      <h1 class="text-3xl font-bold">Weatherman</h1>
      <a href="https://github.com/bryanwhiting/weatherman" target="_blank" rel="noreferrer" class="text-slate-400 hover:text-slate-200" aria-label="GitHub repository">
        <svg viewBox="0 0 24 24" class="h-5 w-5" fill="currentColor" aria-hidden="true">
          <path d="M12 .5a12 12 0 0 0-3.79 23.39c.6.11.82-.26.82-.58v-2.02c-3.34.73-4.04-1.41-4.04-1.41-.55-1.38-1.34-1.75-1.34-1.75-1.1-.74.08-.72.08-.72 1.21.09 1.85 1.22 1.85 1.22 1.08 1.82 2.82 1.3 3.5.99.11-.77.42-1.3.76-1.6-2.67-.3-5.47-1.32-5.47-5.86 0-1.29.47-2.35 1.23-3.18-.12-.3-.53-1.53.12-3.19 0 0 1-.32 3.3 1.21a11.6 11.6 0 0 1 6 0c2.3-1.53 3.3-1.21 3.3-1.21.65 1.66.24 2.89.12 3.19.77.83 1.23 1.89 1.23 3.18 0 4.55-2.8 5.55-5.48 5.85.43.37.82 1.1.82 2.22v3.29c0 .32.22.7.83.58A12 12 0 0 0 12 .5Z"/>
        </svg>
      </a>
    </div>
    <div class="text-xs text-slate-500">{version}</div>
  </div>
  <p class="text-slate-400 mt-1">Forecast requests submitted via GitHub Actions. Click any run for full report.</p>

  <section class="mt-4 rounded-xl border border-slate-700 bg-slate-900/70 p-4">
    <h2 class="text-xl font-semibold mb-2">Submit Forecast Run</h2>

    <div class="space-y-3">
      <div>
        <label class="block text-sm text-slate-300 mb-1">Supply a payload, or run a test</label>
        <div class="grid grid-cols-2 gap-2">
          <button type="button" class="tab active rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm font-medium" id="tab-payload">Supply payload</button>
          <button type="button" class="tab rounded-lg border border-slate-600 bg-slate-900 px-3 py-2 text-sm font-medium" id="tab-test">Run M5 test</button>
        </div>
        <input id="use_m5" type="hidden" value="false" />
      </div>

      <div>
        <label for="payload" class="block text-sm text-slate-300 mb-1">Payload JSON</label>
        <details class="rounded-lg border border-slate-700 bg-slate-900 p-2 mb-2">
          <summary class="cursor-pointer text-sm text-sky-300">Payload instructions</summary>
          <div class="mt-2 text-xs md:text-sm text-slate-200 space-y-2">
            <p>⚠️ <strong>Time series are assumed to be continuous at your time granularity!</strong> If not, backfill them.</p>
            <ul class="list-disc ml-5 space-y-1">
              <li>Payload is JSON only.</li>
              <li>For custom runs, provide values in <code>series</code>.</li>
              <li>For M5 test mode, use <code>series_names: ["demo_mode_m5"]</code> and <code>series: []</code>.</li>
            </ul>
            <div class="overflow-x-auto">
              <table class="min-w-[680px] text-xs border border-slate-700">
                <thead class="bg-slate-800"><tr><th class="p-2 border border-slate-700 text-left">Field</th><th class="p-2 border border-slate-700 text-left">Required</th><th class="p-2 border border-slate-700 text-left">Description</th><th class="p-2 border border-slate-700 text-left">Example</th></tr></thead>
                <tbody>
                  <tr><td class="p-2 border border-slate-700"><code>run_name_root</code></td><td class="p-2 border border-slate-700">Yes</td><td class="p-2 border border-slate-700">Base run name; backend prepends timestamp</td><td class="p-2 border border-slate-700"><code>my-run</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>series_names</code></td><td class="p-2 border border-slate-700">Custom mode</td><td class="p-2 border border-slate-700">List of series names</td><td class="p-2 border border-slate-700"><code>["a","b"]</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>series</code></td><td class="p-2 border border-slate-700">Custom mode</td><td class="p-2 border border-slate-700">Single list or list-of-lists</td><td class="p-2 border border-slate-700"><code>[[...],[...]]</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>n_series</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">M5 sample series count</td><td class="p-2 border border-slate-700"><code>3</code></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>
        <textarea id="payload" class="w-full min-h-52 rounded-lg border border-slate-700 bg-slate-950 p-3 font-mono text-sm">{defaultPayload}</textarea>
      </div>

      <div>
        <button id="submit-btn" class="rounded-lg bg-sky-700 hover:bg-sky-600 px-4 py-2 font-semibold">Submit run</button>
        <div id="status" class="mt-2 text-sm text-slate-300"></div>
      </div>
    </div>
  </section>

  {leaderboard.length > 0 && (
    <section class="mt-4 rounded-xl border border-slate-700 bg-slate-900/70 p-4 overflow-x-auto">
      <h2 class="text-lg font-semibold mb-2">Leaderboard (avg SMAPE)</h2>
      <table class="min-w-[420px] text-sm w-full">
        <thead><tr class="text-slate-300"><th class="text-left p-2">Rank</th><th class="text-left p-2">Model</th><th class="text-left p-2">Avg SMAPE</th><th class="text-left p-2">Samples</th></tr></thead>
        <tbody>
          {leaderboard.map((row, idx) => (
            <tr>
              <td class="p-2">{idx + 1}</td><td class={`p-2 ${idx===0?'text-emerald-400 font-semibold':''}`}>{row.model}</td><td class="p-2">{row.avgSmape.toFixed(4)}</td><td class="p-2">{row.samples}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </section>
  )}

  <section class="mt-4 grid gap-3">
    {runs.map((run) => (
      <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-4">
        <h3 class="font-semibold text-sky-300"><a href={run.path}>{run.title}</a></h3>
        <p class="text-sm text-slate-400 mt-1">{run.backend} · {run.granularity} · horizon {run.horizon} · history {run.history_points} · forecast {run.forecast_points}</p>
      </article>
    ))}
  </section>

  <script type="module">
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('submit-btn');
    const payloadTab = document.getElementById('tab-payload');
    const testTab = document.getElementById('tab-test');
    const useM5Input = document.getElementById('use_m5');
    const payloadInput = document.getElementById('payload');
    let customPayloadCache = payloadInput.value;

    const setMode = (useM5) => {
      useM5Input.value = String(useM5);
      payloadTab.classList.toggle('active', !useM5);
      testTab.classList.toggle('active', useM5);
      payloadTab.classList.toggle('bg-slate-800', !useM5); payloadTab.classList.toggle('bg-slate-900', useM5);
      testTab.classList.toggle('bg-slate-800', useM5); testTab.classList.toggle('bg-slate-900', !useM5);
      if (useM5) {
        customPayloadCache = payloadInput.value;
        payloadInput.value = JSON.stringify({ start_datetime: '2026-01-01T00:00:00', granularity: '1d', horizon: 24, model: 'nixtla', run_name_root: 'demo-m5-test', n_series: 3, backtest_windows: 3, series_names: ['demo_mode_m5'], series: [] }, null, 2);
        payloadInput.readOnly = true;
        payloadInput.style.opacity = '0.65';
      } else {
        payloadInput.readOnly = false;
        payloadInput.style.opacity = '1';
        if (customPayloadCache?.trim()) payloadInput.value = customPayloadCache;
      }
    };

    payloadTab?.addEventListener('click', () => setMode(false));
    testTab?.addEventListener('click', () => setMode(true));

    btn?.addEventListener('click', async () => {
      try {
        statusEl.textContent = 'Submitting...';
        btn.disabled = true;
        const use_m5 = document.getElementById('use_m5').value === 'true';
        const payloadRaw = document.getElementById('payload').value;
        const parsedPayload = JSON.parse(payloadRaw || '{}');
        const runNameRoot = String(parsedPayload?.run_name_root || '').trim();
        if (!runNameRoot) throw new Error('payload.run_name_root is required');

        const body = {
          repo: 'bryanwhiting/weatherman',
          run_name_root: runNameRoot,
          use_m5,
          payload: payloadRaw,
          backtest_windows: Number(parsedPayload?.backtest_windows ?? 3),
        };

        const res = await fetch('/api/dispatch', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const json = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(json?.error || `Request failed (${res.status})`);
        const link = json?.actions_url || 'https://github.com/bryanwhiting/weatherman/actions/workflows/forecast-request.yml';
        statusEl.innerHTML = `✅ Dispatched as <code>${json?.slug || 'run'}</code><br/><a href="${link}" target="_blank" rel="noreferrer" class="text-sky-300 underline">View GitHub Action</a>`;
      } catch (err) {
        statusEl.textContent = `❌ ${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</MainLayout>
