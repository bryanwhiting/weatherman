---
import runs from '../data/forecast-index.json';

const forecastModules = import.meta.glob('../data/forecasts/*.json', { eager: true });
const allBacktests = Object.values(forecastModules)
  .map((mod: any) => mod.default ?? mod)
  .flatMap((data: any) => data.backtest ?? []);

const leaderboardMap = new Map<string, { total: number; count: number }>();
for (const row of allBacktests) {
  const model = row.model;
  const smape = Number(row.smape);
  if (!model || Number.isNaN(smape)) continue;
  const current = leaderboardMap.get(model) ?? { total: 0, count: 0 };
  leaderboardMap.set(model, { total: current.total + smape, count: current.count + 1 });
}

const leaderboard = Array.from(leaderboardMap.entries())
  .map(([model, stats]) => ({
    model,
    avgSmape: stats.total / stats.count,
    samples: stats.count,
  }))
  .sort((a, b) => a.avgSmape - b.avgSmape);

const defaultPayload = JSON.stringify({
  start_datetime: '2026-01-01T17:15:00',
  granularity: '1h',
  series_name: 'demo_hourly',
  horizon: 24,
  model: 'nixtla',
  series: [100, 102, 99, 101, 103, 104, 106, 108, 110, 111, 113, 116],
}, null, 2);
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Weatherman</title>
    <style>
      body { font-family: Inter, system-ui, sans-serif; margin: 0; background: #0b1020; color: #e6edf7; }
      main { max-width: 980px; margin: 0 auto; padding: 2rem 1rem 4rem; }
      h1 { margin: 0; font-size: 2rem; }
      h2 { margin: 0 0 .75rem; font-size: 1.1rem; }
      .sub { color: #a3b3d1; margin-top: .5rem; }
      .grid { margin-top: 1.5rem; display: grid; gap: .9rem; }
      .card { background: #141b31; border: 1px solid #273255; border-radius: 12px; padding: 1rem; }
      .meta { color: #9db0d4; font-size: .9rem; display: flex; gap: .75rem; flex-wrap: wrap; }
      .leader-wrap { margin-top: 1.5rem; }
      table { border-collapse: collapse; width: 100%; max-width: 520px; }
      th, td { border: 1px solid #273255; padding: 8px 10px; text-align: left; }
      th { background: #111935; color: #c7d7f8; }
      td { color: #d9e4fa; }
      .winner { color: #86efac; font-weight: 600; }
      a { color: #8cc0ff; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .empty { margin-top: 2rem; color: #9db0d4; }

      .form-grid { display: grid; gap: .6rem; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: .6rem; }
      label { font-size: .85rem; color: #b7c5e2; display: block; margin-bottom: .2rem; }
      input, textarea, select { width: 100%; border: 1px solid #2c3a61; background: #0f1730; color: #eaf1ff; border-radius: 8px; padding: .55rem .65rem; font: inherit; }
      textarea { min-height: 120px; }
      button { border: 1px solid #3f568d; background: #1c2a4d; color: #eaf1ff; border-radius: 8px; padding: .6rem .8rem; cursor: pointer; }
      button:hover { background: #243866; }
      .muted { color: #98abd3; font-size: .85rem; }
      .status { margin-top: .5rem; font-size: .9rem; }
      @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <main>
      <h1>Weatherman</h1>
      <p class="sub">Forecast requests submitted via GitHub Actions. Click any run for the full HTML report.</p>

      <section class="card" style="margin-top:1rem;">
        <h2>Submit Forecast Run</h2>
        <p class="muted">This sends a <code>workflow_dispatch</code> POST to GitHub Actions for <code>forecast-request.yml</code>.</p>
        <div class="form-grid">
          <div class="row">
            <div>
              <label for="repo">Repo (owner/name)</label>
              <input id="repo" value="bryanwhiting/weatherman" />
            </div>
            <div>
              <label for="slug">Slug</label>
              <input id="slug" placeholder="my-forecast-run" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="use_m5">Dataset</label>
              <select id="use_m5">
                <option value="false">Custom payload</option>
                <option value="true">M5 sample</option>
              </select>
            </div>
            <div>
              <label for="m5_series_count">M5 series count</label>
              <input id="m5_series_count" type="number" value="3" min="1" max="20" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="backtest_windows">Rolling backtest windows</label>
              <input id="backtest_windows" type="number" value="3" min="1" max="20" />
            </div>
            <div>
              <label for="token">GitHub token (workflow scope)</label>
              <input id="token" type="password" placeholder="ghp_..." />
            </div>
          </div>

          <div>
            <label for="payload">Payload JSON</label>
            <textarea id="payload">{defaultPayload}</textarea>
          </div>

          <div>
            <button id="submit-btn">Submit run</button>
            <span id="status" class="status"></span>
          </div>
        </div>
      </section>

      {leaderboard.length > 0 && (
        <section class="leader-wrap card">
          <h2>Leaderboard (avg SMAPE across rolling backtests)</h2>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Model</th>
                <th>Avg SMAPE</th>
                <th>Samples</th>
              </tr>
            </thead>
            <tbody>
              {leaderboard.map((row, idx) => (
                <tr>
                  <td>{idx + 1}</td>
                  <td class={idx === 0 ? 'winner' : ''}>{row.model}</td>
                  <td>{row.avgSmape.toFixed(4)}</td>
                  <td>{row.samples}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </section>
      )}

      {runs.length === 0 ? (
        <p class="empty">No forecast runs yet.</p>
      ) : (
        <section class="grid">
          {runs.map((run) => (
            <article class="card">
              <h2><a href={run.path}>{run.title}</a></h2>
              <div class="meta">
                <span>Backend: {run.backend}</span>
                <span>Granularity: {run.granularity}</span>
                <span>Horizon: {run.horizon}</span>
                <span>History: {run.history_points}</span>
                <span>Forecast: {run.forecast_points}</span>
                <span>{new Date(run.created_at).toLocaleString()}</span>
                {run.run_url && <a href={run.run_url} target="_blank" rel="noreferrer">GitHub run ↗</a>}
              </div>
            </article>
          ))}
        </section>
      )}
    </main>

    <script type="module">
      const statusEl = document.getElementById('status');
      const btn = document.getElementById('submit-btn');
      const tokenInput = document.getElementById('token');

      // convenience: remember token locally on this browser only
      const saved = localStorage.getItem('weatherman_gh_token');
      if (saved && tokenInput) tokenInput.value = saved;

      btn?.addEventListener('click', async () => {
        try {
          statusEl.textContent = 'Submitting...';
          btn.disabled = true;

          const repo = document.getElementById('repo').value.trim();
          const slug = document.getElementById('slug').value.trim();
          const use_m5 = document.getElementById('use_m5').value;
          const m5_series_count = document.getElementById('m5_series_count').value;
          const backtest_windows = document.getElementById('backtest_windows').value;
          const payloadRaw = document.getElementById('payload').value;
          const token = tokenInput.value.trim();

          if (!repo || !slug || !token) throw new Error('repo, slug, and token are required');
          JSON.parse(payloadRaw); // validate

          localStorage.setItem('weatherman_gh_token', token);

          const url = `https://api.github.com/repos/${repo}/actions/workflows/forecast-request.yml/dispatches`;
          const body = {
            ref: 'main',
            inputs: {
              slug,
              use_m5,
              m5_series_count: String(m5_series_count),
              payload: payloadRaw,
              backtest_windows: String(backtest_windows),
            },
          };

          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Accept': 'application/vnd.github+json',
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          });

          if (!res.ok) {
            const txt = await res.text();
            throw new Error(`GitHub API ${res.status}: ${txt}`);
          }

          statusEl.textContent = '✅ Dispatched. Check Actions tab for progress.';
        } catch (err) {
          statusEl.textContent = `❌ ${err.message}`;
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
