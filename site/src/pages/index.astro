---
import runs from '../data/forecast-index.json';
import { execSync } from 'node:child_process';

const forecastModules = import.meta.glob('../data/forecasts/*.json', { eager: true });
const allBacktests = Object.values(forecastModules)
  .map((mod: any) => mod.default ?? mod)
  .flatMap((data: any) => data.backtest ?? []);

const leaderboardMap = new Map<string, { total: number; count: number }>();
for (const row of allBacktests) {
  const model = row.model;
  const smape = Number(row.smape);
  if (!model || Number.isNaN(smape)) continue;
  const current = leaderboardMap.get(model) ?? { total: 0, count: 0 };
  leaderboardMap.set(model, { total: current.total + smape, count: current.count + 1 });
}

const leaderboard = Array.from(leaderboardMap.entries())
  .map(([model, stats]) => ({
    model,
    avgSmape: stats.total / stats.count,
    samples: stats.count,
  }))
  .sort((a, b) => a.avgSmape - b.avgSmape);

const defaultPayload = JSON.stringify({
  start_datetime: '2026-01-01T17:15:00',
  granularity: '1h',
  series_name: 'demo_hourly',
  horizon: 24,
  model: 'nixtla',
  run_name_root: 'my-forecast-run',
  n_series: 2,
  backtest_windows: 3,
  series: [
    [100, 102, 99, 101, 103, 104, 106, 108, 110, 111, 113, 116],
    [80, 82, 81, 83, 86, 88, 87, 89, 91, 94, 96, 97]
  ],
}, null, 2);

const gitHash = (() => {
  try { return execSync('git rev-parse --short HEAD').toString().trim(); } catch { return 'nogit'; }
})();
const ymdhms = (() => {
  const d = new Date();
  const yy = String(d.getUTCFullYear()).slice(-2);
  const mo = String(d.getUTCMonth() + 1).padStart(2, '0');
  const da = String(d.getUTCDate()).padStart(2, '0');
  const hh = String(d.getUTCHours()).padStart(2, '0');
  const mi = String(d.getUTCMinutes()).padStart(2, '0');
  const ss = String(d.getUTCSeconds()).padStart(2, '0');
  return `${yy}${mo}${da}${hh}${mi}${ss}`;
})();
const version = `v0.${ymdhms}-${gitHash}`;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Weatherman</title>
    <style>
      * { box-sizing: border-box; }
      body { font-family: Inter, system-ui, sans-serif; margin: 0; background: #0b1020; color: #e6edf7; overflow-x: hidden; }
      main { max-width: 980px; margin: 0 auto; padding: 2rem 1rem 4rem; }
      h1 { margin: 0; font-size: 2rem; }
      h2 { margin: 0 0 .75rem; font-size: 1.1rem; }
      .hero { display: flex; align-items: center; justify-content: space-between; gap: .75rem; flex-wrap: wrap; }
      .title-wrap { display: flex; align-items: center; gap: .5rem; }
      .gh-link { display: inline-flex; align-items: center; color: #9db0d4; }
      .gh-link svg { width: 18px; height: 18px; }
      .version { color: #7f8fb2; font-size: .8rem; }
      .sub { color: #a3b3d1; margin-top: .5rem; }
      .grid { margin-top: 1.5rem; display: grid; gap: .9rem; }
      .card { background: #141b31; border: 1px solid #273255; border-radius: 12px; padding: 1rem; overflow: hidden; }
      .meta { color: #9db0d4; font-size: .9rem; display: flex; gap: .75rem; flex-wrap: wrap; }
      .leader-wrap { margin-top: 1.5rem; }
      table { border-collapse: collapse; width: 100%; max-width: 520px; }
      th, td { border: 1px solid #273255; padding: 8px 10px; text-align: left; }
      th { background: #111935; color: #c7d7f8; }
      td { color: #d9e4fa; }
      .winner { color: #86efac; font-weight: 600; }
      a { color: #8cc0ff; text-decoration: none; }
      code { word-break: break-all; }
      a:hover { text-decoration: underline; }
      .empty { margin-top: 2rem; color: #9db0d4; }

      .form-grid { display: grid; gap: .6rem; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: .6rem; }
      .tabs { display: flex; gap: .5rem; margin-top: .2rem; }
      .tab { flex: 1; border: 1px solid #2c3a61; background: #0f1730; color: #cfe0ff; border-radius: 10px; padding: .6rem .7rem; text-align: center; cursor: pointer; }
      .tab.active { background: #1c2a4d; border-color: #4a65a1; color: #fff; font-weight: 600; }
      .instructions { margin: .35rem 0 .15rem; }
      .instructions > summary { cursor: pointer; color: #8cc0ff; font-size: .85rem; }
      .instructions-body { margin-top: .45rem; border: 1px solid #2c3a61; background: #0f1730; border-radius: 10px; padding: .65rem .75rem; color: #cfe0ff; font-size: .84rem; line-height: 1.35; }
      label { font-size: .85rem; color: #b7c5e2; display: block; margin-bottom: .2rem; }
      input, textarea, select { width: 100%; max-width: 100%; border: 1px solid #2c3a61; background: #0f1730; color: #eaf1ff; border-radius: 10px; padding: .62rem .7rem; font: inherit; }
      textarea { min-height: 150px; line-height: 1.35; overflow-wrap: anywhere; }
      button { border: 1px solid #3f568d; background: #1c2a4d; color: #eaf1ff; border-radius: 10px; padding: .7rem .9rem; cursor: pointer; font-weight: 600; }
      button:hover { background: #243866; }
      .muted { color: #98abd3; font-size: .85rem; }
      .status { margin-top: .5rem; font-size: .9rem; display: inline-block; }

      @media (max-width: 720px) {
        main { padding: 1rem .65rem 5.5rem; }
        h1 { font-size: 1.7rem; }
        .sub { font-size: .95rem; }
        .row { grid-template-columns: 1fr; }
        .card { padding: .8rem; border-radius: 10px; }
        .meta { font-size: .82rem; gap: .45rem; }
        table { font-size: .86rem; display: block; overflow-x: auto; max-width: 100%; }
        th, td { padding: 6px 8px; white-space: nowrap; }
        input, textarea, select { font-size: 16px; } /* prevent iOS zoom */
        textarea { min-height: 190px; }
        #submit-btn { width: 100%; }
      }
    </style>
  </head>
  <body>
    <main>
      <div class="hero">
        <div class="title-wrap">
          <h1>Weatherman</h1>
          <a class="gh-link" href="https://github.com/bryanwhiting/weatherman" target="_blank" rel="noreferrer" aria-label="GitHub repo">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 .5a12 12 0 0 0-3.79 23.39c.6.11.82-.26.82-.58v-2.02c-3.34.73-4.04-1.41-4.04-1.41-.55-1.38-1.34-1.75-1.34-1.75-1.1-.74.08-.72.08-.72 1.21.09 1.85 1.22 1.85 1.22 1.08 1.82 2.82 1.3 3.5.99.11-.77.42-1.3.76-1.6-2.67-.3-5.47-1.32-5.47-5.86 0-1.29.47-2.35 1.23-3.18-.12-.3-.53-1.53.12-3.19 0 0 1-.32 3.3 1.21a11.6 11.6 0 0 1 6 0c2.3-1.53 3.3-1.21 3.3-1.21.65 1.66.24 2.89.12 3.19.77.83 1.23 1.89 1.23 3.18 0 4.55-2.8 5.55-5.48 5.85.43.37.82 1.1.82 2.22v3.29c0 .32.22.7.83.58A12 12 0 0 0 12 .5Z"/></svg>
          </a>
        </div>
        <div class="version">{version}</div>
      </div>
      <p class="sub">Forecast requests submitted via GitHub Actions. Click any run for the full HTML report.</p>

      <section class="card" style="margin-top:1rem;">
        <h2>Submit Forecast Run</h2>
        <p class="muted">This sends a <code>workflow_dispatch</code> POST to GitHub Actions for <code>forecast-request.yml</code>.</p>
        <div class="form-grid">
          <div>
            <label>Supply a payload, or run a test</label>
            <div class="tabs">
              <button type="button" class="tab active" id="tab-payload">Supply payload</button>
              <button type="button" class="tab" id="tab-test">Run M5 test</button>
            </div>
            <input id="use_m5" type="hidden" value="false" />
          </div>

          <div>
            <label for="payload">Payload JSON</label>
            <details class="instructions">
              <summary>Payload instructions</summary>
              <div class="instructions-body">
                <p>⚠️ <strong>Time series are assumed to be continuous at your time granularity!</strong> If they're not, you need to backfill them.</p>
                <ul>
                  <li>Payload is JSON only.</li>
                  <li>For custom runs, provide your values in <code>series</code>.</li>
                  <li>For M5 test mode, the app sets <code>series_name</code> to <code>demo_mode_m5</code> automatically.</li>
                </ul>
                <table>
                  <thead>
                    <tr><th>Field</th><th>Required</th><th>Description</th><th>Example</th></tr>
                  </thead>
                  <tbody>
                    <tr><td><code>run_name_root</code></td><td>Yes</td><td>Base name used for slug generation (timestamp is prepended automatically)</td><td><code>my-forecast-run</code></td></tr>
                    <tr><td><code>start_datetime</code></td><td>Custom mode</td><td>First timestamp in ISO format</td><td><code>2026-01-01T17:15:00</code></td></tr>
                    <tr><td><code>granularity</code></td><td>Custom mode</td><td>Series frequency</td><td><code>1h</code>, <code>1d</code></td></tr>
                    <tr><td><code>series_name</code></td><td>Custom mode</td><td>Name of the series (<code>demo_mode_m5</code> is reserved)</td><td><code>demand_store_1</code></td></tr>
                    <tr><td><code>horizon</code></td><td>No</td><td>Forecast periods ahead</td><td><code>24</code></td></tr>
                    <tr><td><code>n_series</code></td><td>No</td><td>Number of series to use (for M5 sampling and optional metadata)</td><td><code>3</code></td></tr>\n                    <tr><td><code>backtest_windows</code></td><td>No</td><td>Rolling backtest window count</td><td><code>3</code></td></tr>
                    <tr><td><code>model</code></td><td>No</td><td>Forecast backend selector</td><td><code>nixtla</code></td></tr>
                    <tr><td><code>series</code></td><td>Custom mode</td><td>Numeric values in order (no gaps implied)</td><td><code>[100,102,99,...]</code></td></tr>
                  </tbody>
                </table>
              </div>
            </details>
            <textarea id="payload">{defaultPayload}</textarea>
          </div>

          <div>
            <button id="submit-btn">Submit run</button>
            <span id="status" class="status"></span>
          </div>
        </div>
      </section>

      {leaderboard.length > 0 && (
        <section class="leader-wrap card">
          <h2>Leaderboard (avg SMAPE across rolling backtests)</h2>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Model</th>
                <th>Avg SMAPE</th>
                <th>Samples</th>
              </tr>
            </thead>
            <tbody>
              {leaderboard.map((row, idx) => (
                <tr>
                  <td>{idx + 1}</td>
                  <td class={idx === 0 ? 'winner' : ''}>{row.model}</td>
                  <td>{row.avgSmape.toFixed(4)}</td>
                  <td>{row.samples}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </section>
      )}

      {runs.length === 0 ? (
        <p class="empty">No forecast runs yet.</p>
      ) : (
        <section class="grid">
          {runs.map((run) => (
            <article class="card">
              <h2><a href={run.path}>{run.title}</a></h2>
              <div class="meta">
                <span>Backend: {run.backend}</span>
                <span>Granularity: {run.granularity}</span>
                <span>Horizon: {run.horizon}</span>
                <span>History: {run.history_points}</span>
                <span>Forecast: {run.forecast_points}</span>
                <span>{new Date(run.created_at).toLocaleString()}</span>
                {run.run_url && <a href={run.run_url} target="_blank" rel="noreferrer">GitHub run ↗</a>}
              </div>
            </article>
          ))}
        </section>
      )}
    </main>

    <script type="module">
      const statusEl = document.getElementById('status');
      const btn = document.getElementById('submit-btn');
      const payloadTab = document.getElementById('tab-payload');
      const testTab = document.getElementById('tab-test');
      const useM5Input = document.getElementById('use_m5');
      const payloadInput = document.getElementById('payload');
      let customPayloadCache = payloadInput.value;

      const setMode = (useM5) => {
        useM5Input.value = String(useM5);
        payloadTab.classList.toggle('active', !useM5);
        testTab.classList.toggle('active', useM5);

        if (useM5) {
          customPayloadCache = payloadInput.value;
          payloadInput.value = JSON.stringify({ run_name_root: 'demo-m5-test', series_name: 'demo_mode_m5', n_series: 3, backtest_windows: 3, series: [] }, null, 2);
          payloadInput.readOnly = true;
          payloadInput.style.opacity = '0.55';
        } else {
          payloadInput.readOnly = false;
          payloadInput.style.opacity = '1';
          if (customPayloadCache && customPayloadCache.trim()) payloadInput.value = customPayloadCache;
        }
      };

      payloadTab?.addEventListener('click', () => setMode(false));
      testTab?.addEventListener('click', () => setMode(true));

      btn?.addEventListener('click', async () => {
        try {
          statusEl.textContent = 'Submitting...';
          btn.disabled = true;

          const use_m5 = document.getElementById('use_m5').value === 'true';
          const payloadRaw = document.getElementById('payload').value;

          const parsedPayload = JSON.parse(payloadRaw || '{}'); // validate + inspect
          const runNameRoot = String(parsedPayload?.run_name_root || '').trim();
          if (!runNameRoot) throw new Error('payload.run_name_root is required');

          const body = {
            repo: 'bryanwhiting/weatherman',
            run_name_root: runNameRoot,
            use_m5,
            payload: payloadRaw,
            backtest_windows: Number(backtest_windows),
          };

          const res = await fetch('/api/dispatch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });

          const json = await res.json().catch(() => ({}));
          if (!res.ok) {
            throw new Error(json?.error || `Request failed (${res.status})`);
          }

          statusEl.textContent = `✅ Dispatched as ${json?.slug || 'run'}. Check Actions tab for progress.`;
        } catch (err) {
          statusEl.textContent = `❌ ${err.message}`;
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
