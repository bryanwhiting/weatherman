---
import MainLayout from '../layouts/MainLayout.astro';
import Navbar from '../components/Navbar.astro';

const forecastModules = import.meta.glob('../data/forecasts/*.json', { eager: true });
const forecastData = Object.values(forecastModules).map((mod: any) => mod.default ?? mod);
const runs = forecastData
  .map((d: any) => ({
    slug: d?.meta?.slug || d?.request?.run_name_root || 'run',
    backend: d?.backend || 'nixtla',
    granularity: d?.request?.granularity || 'n/a',
    horizon: d?.request?.horizon ?? 'n/a',
    history_points: (d?.history || []).length,
    forecast_points: (d?.forecast || []).length,
    created_at: d?.meta?.created_at || '',
    path: `/forecasts/${d?.meta?.slug || d?.request?.run_name_root || 'run'}`,
  }))
  .sort((a, b) => String(b.created_at).localeCompare(String(a.created_at)));

const defaultPayload = JSON.stringify({
  run_name_root: 'my-forecast-run',
  start_datetime: '2026-01-01T00:00:00',
  granularity: '1d',
  seasonal_period: 7,
  backtest_windows: 3,
  horizon: 7,
  model: 'nixtla',
  series_names: ['trend', 'seasonal', 'combined'],
  series_data: [
    [100, 103, 101, 106, 108, 107, 111, 114, 113, 117, 116, 120, 123, 121, 126, 128, 127, 131, 134, 132, 137, 139, 138, 142, 145, 143, 148, 150, 149, 153, 156, 154, 159, 161, 160, 164, 167, 165, 170, 172, 171, 175, 178, 176, 181, 183, 182, 186, 189],
    [13, 18, 25, 17, 9, 14, 22, 12, 18, 25, 17, 9, 14, 22, 13, 18, 25, 17, 9, 14, 22, 12, 18, 25, 17, 9, 14, 22, 13, 18, 25, 17, 9, 14, 22, 12, 18, 25, 17, 9, 14, 22, 13, 18, 25, 17, 9, 14, 22],
    [114, 119, 131, 121, 119, 123, 136, 124, 136, 142, 139, 130, 140, 149, 139, 150, 156, 153, 143, 154, 163, 152, 164, 170, 167, 158, 168, 177, 167, 178, 184, 181, 171, 182, 191, 180, 192, 198, 195, 186, 196, 205, 195, 206, 212, 209, 199, 210, 219]
  ]
}, null, 2);
---
<MainLayout title="ForecastingAPI.com">
  <style>
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(56,189,248,.35); opacity: .95; }
      50% { box-shadow: 0 0 0 10px rgba(56,189,248,0); opacity: 1; }
    }
    @keyframes popIn {
      0% { transform: translateY(6px) scale(.98); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .status-anim-start {
      animation: popIn .25s ease-out, pulseGlow 1.5s ease-in-out infinite;
      border: 1px solid rgba(56,189,248,.35);
      border-radius: .5rem;
      padding: .4rem .55rem;
      background: rgba(15,23,42,.5);
      display: inline-block;
    }
    .status-anim-finish {
      animation: popIn .25s ease-out;
      border: 1px solid rgba(16,185,129,.4);
      border-radius: .5rem;
      padding: .4rem .55rem;
      background:
        linear-gradient(90deg, rgba(16,185,129,.18), rgba(52,211,153,.08), rgba(16,185,129,.18));
      background-size: 220% 100%;
      animation: popIn .25s ease-out, shimmer 1.8s linear 1;
      display: inline-block;
    }
    .run-chip {
      border: 1px solid rgba(51,65,85,.9);
      border-radius: .7rem;
      padding: .5rem .65rem;
      background: rgba(15,23,42,.62);
      transition: border-color .2s ease, background-color .2s ease;
    }
    .run-chip.in-progress {
      border-color: rgba(56,189,248,.55);
      background: rgba(8,47,73,.35);
      animation: pulseGlow 1.15s ease-in-out infinite;
    }
    .run-chip.success {
      border-color: rgba(34,197,94,.5);
      background: rgba(20,83,45,.28);
      animation: none;
    }
    .run-chip.failure {
      border-color: rgba(239,68,68,.55);
      background: rgba(127,29,29,.26);
      animation: none;
    }
    .run-dot {
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:999px;
      margin-right:8px;
      vertical-align:middle;
      transform: translateY(-1px);
    }
    .run-dot.in-progress { background: rgb(56,189,248); }
    .run-dot.success { background: rgb(34,197,94); }
    .run-dot.failure { background: rgb(239,68,68); }
  </style>
  <Navbar />
  <div aria-hidden="true" class="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
    <div id="weather-parallax" class="absolute inset-0 opacity-40">
      <svg id="weather-svg" class="h-full w-full"></svg>
    </div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_10%_10%,rgba(56,189,248,0.08),transparent_35%),radial-gradient(circle_at_80%_0%,rgba(99,102,241,0.09),transparent_35%),linear-gradient(to_bottom,rgba(2,6,23,0.65),rgba(2,6,23,0.95))]"></div>
  </div>


  <section class="relative mt-5 overflow-hidden rounded-2xl border border-slate-700/80 bg-gradient-to-b from-slate-900 via-slate-900 to-slate-950 p-6 md:p-8">
    <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_10%_20%,rgba(56,189,248,0.15),transparent_35%),radial-gradient(circle_at_90%_10%,rgba(99,102,241,0.15),transparent_30%)]"></div>
    <div class="relative">
      <p class="text-xs uppercase tracking-[0.18em] text-sky-300/90">Serverless Forecasting Engine</p>
      <h1 class="mt-2 text-3xl font-semibold leading-tight md:text-5xl">Welcome to the Forecasting API</h1>
      <p class="mt-3 max-w-3xl text-slate-300">ForecastingAPI.com turns compact JSON payloads into production-grade forecasts, rolling backtests, SMAPE accuracy reports, and shareable run pages — all in one flow.</p>

      <div class="mt-6 flex flex-wrap gap-3">
        <a href="#payload-form" class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-500">Start forecasting</a>
        <a href="/m5" class="rounded-lg border border-slate-600 bg-slate-900/80 px-4 py-2 text-sm font-semibold text-sky-200 transition hover:border-sky-400">What is M5 and why it matters?</a>
      </div>
    </div>
  </section>

  <section class="mt-5 relative overflow-hidden rounded-2xl">
    <div class="hidden md:block absolute inset-0 pointer-events-none -z-0">
      <svg class="w-full h-full" viewBox="0 0 1200 220" preserveAspectRatio="none" aria-hidden="true">
        <defs>
          <linearGradient id="flowLine" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="rgba(56,189,248,0.28)" />
            <stop offset="50%" stop-color="rgba(167,139,250,0.35)" />
            <stop offset="100%" stop-color="rgba(16,185,129,0.28)" />
          </linearGradient>
        </defs>
        <path d="M80 110 C 260 60, 340 160, 520 110 S 780 60, 960 110 S 1080 150, 1140 110" fill="none" stroke="url(#flowLine)" stroke-width="4" stroke-linecap="round" />
        <circle cx="80" cy="110" r="6" fill="rgba(56,189,248,0.5)"/>
        <circle cx="520" cy="110" r="6" fill="rgba(167,139,250,0.55)"/>
        <circle cx="960" cy="110" r="6" fill="rgba(16,185,129,0.5)"/>
      </svg>
    </div>
    <div class="relative z-10 grid gap-4 md:grid-cols-3">
      <article class="group rounded-2xl border border-slate-700 bg-slate-900/70 p-4 md:p-5 shadow-[inset_0_1px_0_rgba(255,255,255,0.04),0_0_0_1px_rgba(56,189,248,0.06),0_14px_40px_rgba(2,6,23,0.45)] hover:border-sky-400/60 transition">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 rounded-full bg-sky-500/20 border border-sky-400/50 text-sky-300 text-sm font-bold grid place-items-center">1</div>
          <h3 class="font-semibold tracking-wide">Ingest</h3>
        </div>
        <p class="mt-3 text-sm text-slate-300">Paste one payload with multi-series data. Keep it compact and deterministic.</p>
      </article>

      <article class="group rounded-2xl border border-slate-700 bg-slate-900/70 p-4 md:p-5 shadow-[inset_0_1px_0_rgba(255,255,255,0.04),0_0_0_1px_rgba(56,189,248,0.06),0_14px_40px_rgba(2,6,23,0.45)] hover:border-violet-400/60 transition">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 rounded-full bg-violet-500/20 border border-violet-400/50 text-violet-300 text-sm font-bold grid place-items-center">2</div>
          <h3 class="font-semibold tracking-wide">Evaluate</h3>
        </div>
        <p class="mt-3 text-sm text-slate-300">Run rolling backtests with AutoARIMA + AutoETS, then compare SMAPE by model/window.</p>
      </article>

      <article class="group rounded-2xl border border-slate-700 bg-slate-900/70 p-4 md:p-5 shadow-[inset_0_1px_0_rgba(255,255,255,0.04),0_0_0_1px_rgba(56,189,248,0.06),0_14px_40px_rgba(2,6,23,0.45)] hover:border-emerald-400/60 transition">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 rounded-full bg-emerald-500/20 border border-emerald-400/50 text-emerald-300 text-sm font-bold grid place-items-center">3</div>
          <h3 class="font-semibold tracking-wide">Ship</h3>
        </div>
        <p class="mt-3 text-sm text-slate-300">Get a permalinked forecast report with per-series charts and backfill diagnostics.</p>
      </article>
    </div>
  </section>

  <section id="payload-form" class="mt-5 rounded-2xl border border-slate-600/80 bg-slate-900/75 p-4 md:p-6 shadow-[0_16px_50px_rgba(2,6,23,0.45),0_0_0_1px_rgba(56,189,248,0.08)]">
    <h2 class="text-2xl font-semibold">Enter Payload, get Forecasts</h2>
    <p class="mt-1 text-sm text-slate-300">Supply your own payload, or use our M5 demo</p>

    <div class="mt-4 space-y-4">
      <div>
        <div class="grid grid-cols-2 gap-2">
          <button type="button" class="tab active rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm font-medium" id="tab-payload">Supply payload</button>
          <button type="button" class="tab rounded-lg border border-slate-600 bg-slate-900 px-3 py-2 text-sm font-medium" id="tab-test">Run M5 demo</button>
        </div>
        <input id="use_m5" type="hidden" value="false" />
      </div>

      <div>
        <label for="payload" class="block text-sm font-medium text-slate-200 mb-2">Paste JSON Payload below</label>
        <details class="rounded-lg border border-slate-700 bg-slate-900 p-3">
          <summary class="cursor-pointer text-sm font-medium text-sky-300">Payload instructions</summary>
          <div class="mt-3 text-xs md:text-sm text-slate-200 space-y-2">
            <p>⚠️ <strong>Time series are assumed to be continuous at your time granularity.</strong> If they are not, backfill them before submitting.</p>
            <div class="overflow-x-auto">
              <table class="min-w-[760px] w-full border border-slate-700 text-xs">
                <thead class="bg-slate-800">
                  <tr>
                    <th class="p-2 text-left border border-slate-700">Field</th>
                    <th class="p-2 text-left border border-slate-700">Required</th>
                    <th class="p-2 text-left border border-slate-700">Description</th>
                    <th class="p-2 text-left border border-slate-700">Example</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td class="p-2 border border-slate-700"><code>run_name_root</code></td><td class="p-2 border border-slate-700">Yes</td><td class="p-2 border border-slate-700">Base run name; app prepends PST timestamp</td><td class="p-2 border border-slate-700"><code>my-run</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>start_datetime</code></td><td class="p-2 border border-slate-700">Custom</td><td class="p-2 border border-slate-700">First timestamp in ISO format</td><td class="p-2 border border-slate-700"><code>2026-01-01T00:00:00</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>granularity</code></td><td class="p-2 border border-slate-700">Custom</td><td class="p-2 border border-slate-700">Step size between points</td><td class="p-2 border border-slate-700"><code>1d</code>, <code>1h</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>horizon</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Forecast periods after history</td><td class="p-2 border border-slate-700"><code>7</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>model</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Engine selector</td><td class="p-2 border border-slate-700"><code>nixtla</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>seasonal_period</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Season length for ARIMA/ETS</td><td class="p-2 border border-slate-700"><code>7</code></td></tr>
                                    <tr><td class="p-2 border border-slate-700"><code>backtest_windows</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Rolling holdout windows for SMAPE</td><td class="p-2 border border-slate-700"><code>3</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>series_names</code></td><td class="p-2 border border-slate-700">Custom</td><td class="p-2 border border-slate-700">Series IDs (<code>demo_mode_m5</code> reserved)</td><td class="p-2 border border-slate-700"><code>["trend","seasonal","combined"]</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>series_data</code></td><td class="p-2 border border-slate-700">Custom</td><td class="p-2 border border-slate-700">Single list or list-of-lists. Must match <code>series_names</code> length.</td><td class="p-2 border border-slate-700"><code>[[...],[...],[...]]</code></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>

        <textarea id="payload" class="mt-3 w-full min-h-60 rounded-xl border border-slate-700 bg-slate-950 p-3 font-mono text-sm">{defaultPayload}</textarea>
      </div>

      <div>
        <button id="submit-btn" class="rounded-lg bg-sky-600 px-4 py-2 font-semibold text-white transition hover:bg-sky-500">Forecast It!</button>
        <div id="status" class="mt-2 text-sm text-slate-300"></div>
        <div id="status-list" class="mt-2 space-y-1 text-sm"></div>
      </div>
    </div>
  </section>

  <section class="mt-5 rounded-2xl border border-slate-600/80 bg-slate-900/75 p-4 md:p-6 shadow-[0_16px_50px_rgba(2,6,23,0.45),0_0_0_1px_rgba(99,102,241,0.08)]">
    <h2 class="text-xl font-semibold">All Runs</h2>
    <p class="mt-1 text-sm text-slate-300">Most recent forecast outputs available right now.</p>
    <div class="mt-4 grid gap-3 md:grid-cols-2">
      {runs.map((run) => (
        <article class="rounded-xl border border-slate-700 bg-slate-900/50 p-4 transition hover:border-sky-500/60 hover:shadow-[0_0_0_1px_rgba(56,189,248,0.18),0_18px_40px_rgba(2,6,23,0.45)]">
          <h3 class="font-semibold text-sky-300"><a href={run.path}>{run.slug}</a></h3>
          <p class="mt-1 text-xs text-slate-400">{run.backend} · {run.granularity} · horizon {run.horizon}</p>
          <p class="text-xs text-slate-400">history {run.history_points} · forecast {run.forecast_points}</p>
        </article>
      ))}
    </div>
  </section>

  <script type="module">
    import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';

    const svg = d3.select('#weather-svg');
    if (!svg.empty()) {
      const render = () => {
        const w = window.innerWidth;
        const h = window.innerHeight;
        svg.attr('viewBox', `0 0 ${w} ${h}`);
        svg.selectAll('*').remove();

        const gBack = svg.append('g').attr('id', 'layer-back');
        const gMid = svg.append('g').attr('id', 'layer-mid');
        const gFront = svg.append('g').attr('id', 'layer-front');

        // Soft cloud clusters (puffy cloud shapes)
        const cloudCenters = d3.range(Math.max(10, Math.floor(w / 130))).map((i) => ({
          x: 40 + (i / Math.max(1, Math.floor(w / 130) - 1)) * (w - 80),
          y: 55 + (Math.sin(i * 0.8) * 18) + (i % 2) * 16,
          scale: 0.8 + (i % 4) * 0.15,
        }));

        const puffOffsets = [
          { dx: -26, dy: 6, r: 20 },
          { dx: -8, dy: -8, r: 24 },
          { dx: 14, dy: -4, r: 22 },
          { dx: 32, dy: 7, r: 18 },
          { dx: 6, dy: 10, r: 20 },
        ];

        cloudCenters.forEach((c, idx) => {
          const alpha = 0.06 + ((idx % 4) * 0.015);
          const grp = gBack.append('g').attr('transform', `translate(${c.x},${c.y}) scale(${c.scale})`);
          puffOffsets.forEach((p) => {
            grp.append('circle')
              .attr('cx', p.dx)
              .attr('cy', p.dy)
              .attr('r', p.r)
              .attr('fill', `rgba(186,230,253,${alpha})`);
          });
          grp.append('ellipse')
            .attr('cx', 4)
            .attr('cy', 16)
            .attr('rx', 44)
            .attr('ry', 12)
            .attr('fill', `rgba(148,163,184,${alpha * 0.55})`);
        });

        // Isobar-like weather contours
        const lineGen = d3.line().curve(d3.curveBasis);
        const contours = d3.range(5).map((k) =>
          d3.range(0, 13).map((i) => [
            (i / 12) * w,
            130 + k * 70 + Math.sin(i * 1.2 + k * 0.75) * 24,
          ])
        );

        gMid.selectAll('path')
          .data(contours)
          .enter()
          .append('path')
          .attr('d', (d) => lineGen(d))
          .attr('fill', 'none')
          .attr('stroke', (d, i) => i % 2 ? 'rgba(167,139,250,0.18)' : 'rgba(56,189,248,0.2)')
          .attr('stroke-width', 1.3);

        // Rain streak accents
        const rain = d3.range(Math.max(24, Math.floor(w / 60))).map((i) => ({
          x: ((i + 0.5) / Math.max(24, Math.floor(w / 60))) * w,
          y: 240 + (i % 7) * 35,
          l: 18 + (i % 4) * 6,
        }));

        gFront.selectAll('line')
          .data(rain)
          .enter()
          .append('line')
          .attr('x1', (d) => d.x)
          .attr('y1', (d) => d.y)
          .attr('x2', (d) => d.x - 8)
          .attr('y2', (d) => d.y + d.l)
          .attr('stroke', 'rgba(125,211,252,0.16)')
          .attr('stroke-width', 1.2)
          .attr('stroke-linecap', 'round');
      };

      const parallax = () => {
        const y = window.scrollY || 0;
        const back = document.getElementById('layer-back');
        const mid = document.getElementById('layer-mid');
        const front = document.getElementById('layer-front');
        if (back) back.setAttribute('transform', `translate(0, ${y * 0.04})`);
        if (mid) mid.setAttribute('transform', `translate(0, ${y * 0.08})`);
        if (front) front.setAttribute('transform', `translate(0, ${y * 0.14})`);
      };

      render();
      parallax();
      window.addEventListener('resize', render, { passive: true });
      window.addEventListener('scroll', parallax, { passive: true });
    }
  </script>

  <script type="module">
    const statusEl = document.getElementById('status');
    const statusListEl = document.getElementById('status-list');
    const btn = document.getElementById('submit-btn');
    const payloadTab = document.getElementById('tab-payload');
    const testTab = document.getElementById('tab-test');
    const useM5Input = document.getElementById('use_m5');
    const payloadInput = document.getElementById('payload');
    let customPayloadCache = payloadInput.value;

    const STORAGE_KEY = 'forecastingapi_recent_runs_v1';
    const activeTimers = new Map();

    const loadRuns = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
    };
    const saveRuns = (runs) => localStorage.setItem(STORAGE_KEY, JSON.stringify(runs.slice(0, 12)));

    const renderRuns = (runs) => {
      if (!statusListEl) return;
      if (!runs.length) return (statusListEl.innerHTML = '');

      statusListEl.innerHTML = runs.map((r) => {
        const statusText = r.status === 'completed' ? (r.conclusion || 'completed') : (r.status || 'queued');
        const forecastHref = `/forecasts/${r.slug}`;
        const href = r.html_url || r.actions_url || 'https://github.com/bryanwhiting/forecastingapi/actions/workflows/forecast-request.yml';

        const state = (r.status === 'completed' && r.conclusion === 'success')
          ? 'success'
          : (r.status === 'completed' ? 'failure' : 'in-progress');
        const dot = `<span class="run-dot ${state}"></span>`;

        if (r.status === 'completed' && r.conclusion === 'success') {
          return `<div class="run-chip success text-xs text-slate-200">${dot}<code>${r.slug}</code> — success · Your forecast is ready: <a href="${forecastHref}" class="text-emerald-300 underline">${forecastHref}</a>, or refresh this browser · <a href="${href}" target="_blank" rel="noreferrer" class="text-sky-300 underline">run</a></div>`;
        }
        if (r.status === 'completed') {
          return `<div class="run-chip failure text-xs text-slate-200">${dot}<code>${r.slug}</code> — failed · <a href="${href}" target="_blank" rel="noreferrer" class="text-red-300 underline">open logs</a></div>`;
        }
        return `<div class="run-chip in-progress text-xs text-slate-200">${dot}<code>${r.slug}</code> — ${statusText} · <a href="${href}" target="_blank" rel="noreferrer" class="text-sky-300 underline">open</a></div>`;
      }).join('');
    };

    const upsertRun = (entry) => {
      const runs = loadRuns();
      const idx = runs.findIndex((r) => r.slug === entry.slug);
      if (idx >= 0) runs[idx] = { ...runs[idx], ...entry };
      else runs.unshift(entry);
      saveRuns(runs);
      renderRuns(runs);
    };

    const pollRun = (slug, statusUrl, actionsUrl) => {
      if (activeTimers.has(slug)) return;
      let tries = 0;
      const maxTries = 60;
      const timer = setInterval(async () => {
        tries += 1;
        try {
          const rs = await fetch(statusUrl);
          const rj = await rs.json();
          if (rj?.found) {
            upsertRun({ slug, status: rj.status, conclusion: rj.conclusion, html_url: rj.html_url, actions_url: actionsUrl, updated_at: rj.updated_at });
            if (rj.status === 'completed') {
              if (rj.conclusion === 'success') {
                statusEl.innerHTML = `<span class="status-anim-finish">✅ Your forecast is ready: <a href="/forecasts/${slug}" class="text-emerald-200 underline">/forecasts/${slug}</a>, or refresh this browser</span>`;
              }
              clearInterval(timer);
              activeTimers.delete(slug);
            }
          } else {
            upsertRun({ slug, status: 'locating', actions_url: actionsUrl });
          }
        } catch {
          upsertRun({ slug, status: 'poll_error', actions_url: actionsUrl });
        }
        if (tries >= maxTries) {
          clearInterval(timer);
          activeTimers.delete(slug);
        }
      }, 6000);
      activeTimers.set(slug, timer);
    };

    const setMode = (useM5) => {
      useM5Input.value = String(useM5);
      payloadTab.classList.toggle('active', !useM5);
      testTab.classList.toggle('active', useM5);
      payloadTab.classList.toggle('bg-slate-800', !useM5);
      payloadTab.classList.toggle('bg-slate-900', useM5);
      testTab.classList.toggle('bg-slate-800', useM5);
      testTab.classList.toggle('bg-slate-900', !useM5);
      if (useM5) {
        customPayloadCache = payloadInput.value;
        payloadInput.value = JSON.stringify({ run_name_root: 'demo-m5-test', start_datetime: '2026-01-01T00:00:00', granularity: '1d', seasonal_period: 7, backtest_windows: 3, horizon: 24, model: 'nixtla', series_names: ['demo_mode_m5'], series_data: [] }, null, 2);
        payloadInput.readOnly = true;
        payloadInput.style.opacity = '0.65';
      } else {
        payloadInput.readOnly = false;
        payloadInput.style.opacity = '1';
        if (customPayloadCache?.trim()) payloadInput.value = customPayloadCache;
      }
    };

    payloadTab?.addEventListener('click', () => setMode(false));
    testTab?.addEventListener('click', () => setMode(true));

    const existing = loadRuns();
    renderRuns(existing);
    existing.filter((r) => r.status && r.status !== 'completed').forEach((r) => {
      const statusUrl = r.status_url || `/api/run-status?slug=${encodeURIComponent(r.slug)}`;
      pollRun(r.slug, statusUrl, r.actions_url);
    });

    btn?.addEventListener('click', async () => {
      try {
        statusEl.innerHTML = '<span class="status-anim-start">⚡ Forecast starting… dispatching job</span>';
        btn.disabled = true;
        const use_m5 = document.getElementById('use_m5').value === 'true';
        const payloadRaw = document.getElementById('payload').value;
        const parsedPayload = JSON.parse(payloadRaw || '{}');
        const runNameRoot = String(parsedPayload?.run_name_root || '').trim();
        if (!runNameRoot) throw new Error('payload.run_name_root is required');
        if (!use_m5) {
          const names = Array.isArray(parsedPayload?.series_names) ? parsedPayload.series_names : [];
          const values = Array.isArray(parsedPayload?.series_data) ? parsedPayload.series_data : [];
          if (names.length !== values.length) throw new Error('len(series_names) must equal len(series_data)');

          const isReal = (x) => typeof x === 'number' && Number.isFinite(x);
          const bad = values.some((series) => {
            if (Array.isArray(series)) return series.some((x) => !isReal(x));
            return !isReal(series);
          });
          if (bad) throw new Error('series_data must contain only real numeric datapoints');
        }

        const body = {
          repo: 'bryanwhiting/forecastingapi',
          run_name_root: runNameRoot,
          use_m5,
          payload: payloadRaw,
          backtest_windows: Number(parsedPayload?.backtest_windows ?? 3),
        };

        const res = await fetch('/api/dispatch', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const json = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(json?.error || `Request failed (${res.status})`);

        const link = json?.actions_url || 'https://github.com/bryanwhiting/forecastingapi/actions/workflows/forecast-request.yml';
        const statusUrl = json?.status_url || `/api/run-status?slug=${encodeURIComponent(json?.slug || '')}`;
        const slug = json?.slug || 'run';

        statusEl.innerHTML = `<span class="status-anim-start">⚡ Dispatched as <code>${slug}</code> · <a href="${link}" target="_blank" rel="noreferrer" class="text-sky-300 underline">View GitHub Action</a></span>`;

        upsertRun({ slug, status: 'queued', actions_url: link, status_url: statusUrl });
        pollRun(slug, statusUrl, link);
      } catch (err) {
        statusEl.textContent = `❌ ${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</MainLayout>
