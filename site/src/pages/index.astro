---
import MainLayout from '../layouts/MainLayout.astro';
import Navbar from '../components/Navbar.astro';

const forecastModules = import.meta.glob('../data/forecasts/*.json', { eager: true });
const forecastData = Object.values(forecastModules).map((mod: any) => mod.default ?? mod);
const runs = forecastData
  .map((d: any) => ({
    slug: d?.meta?.slug || d?.request?.run_name_root || 'run',
    backend: d?.backend || 'nixtla',
    granularity: d?.request?.granularity || 'n/a',
    horizon: d?.request?.horizon ?? 'n/a',
    history_points: (d?.history || []).length,
    forecast_points: (d?.forecast || []).length,
    created_at: d?.meta?.created_at || '',
    path: `/forecasts/${d?.meta?.slug || d?.request?.run_name_root || 'run'}`,
  }))
  .sort((a, b) => String(b.created_at).localeCompare(String(a.created_at)));

const defaultPayload = JSON.stringify({
  start_datetime: '2026-01-01T00:00:00',
  granularity: '1d',
  horizon: 7,
  model: 'nixtla',
  seasonal_period: 7,
  run_name_root: 'my-forecast-run',
  n_series: 3,
  backtest_windows: 3,
  series_names: ['trend', 'seasonal', 'combined'],
  series: [
    [100, 103, 101, 106, 108, 107, 111, 114, 113, 117, 116, 120, 123, 121, 126, 128, 127, 131, 134, 132, 137, 139, 138, 142, 145, 143, 148, 150, 149, 153, 156, 154, 159, 161, 160, 164, 167, 165, 170, 172, 171, 175, 178, 176, 181, 183, 182, 186, 189],
    [13, 18, 25, 17, 9, 14, 22, 12, 18, 25, 17, 9, 14, 22, 13, 18, 25, 17, 9, 14, 22, 12, 18, 25, 17, 9, 14, 22, 13, 18, 25, 17, 9, 14, 22, 12, 18, 25, 17, 9, 14, 22, 13, 18, 25, 17, 9, 14, 22],
    [114, 119, 131, 121, 119, 123, 136, 124, 136, 142, 139, 130, 140, 149, 139, 150, 156, 153, 143, 154, 163, 152, 164, 170, 167, 158, 168, 177, 167, 178, 184, 181, 171, 182, 191, 180, 192, 198, 195, 186, 196, 205, 195, 206, 212, 209, 199, 210, 219]
  ],
}, null, 2);
---
<MainLayout title="ForecastingAPI.com">
  <Navbar />

  <section class="relative mt-5 overflow-hidden rounded-2xl border border-slate-700/80 bg-gradient-to-b from-slate-900 via-slate-900 to-slate-950 p-6 md:p-8">
    <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_10%_20%,rgba(56,189,248,0.15),transparent_35%),radial-gradient(circle_at_90%_10%,rgba(99,102,241,0.15),transparent_30%)]"></div>
    <div class="relative">
      <p class="text-xs uppercase tracking-[0.18em] text-sky-300/90">Serverless Forecasting Engine</p>
      <h1 class="mt-2 text-3xl font-semibold leading-tight md:text-5xl">Welcome to the Forecasting API</h1>
      <p class="mt-3 max-w-3xl text-slate-300">ForecastingAPI.com turns compact JSON payloads into production-grade forecasts, rolling backtests, SMAPE accuracy reports, and shareable run pages — all in one flow.</p>

      <div class="mt-6 flex flex-wrap gap-3">
        <a href="#payload-form" class="rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-500">Start forecasting</a>
        <a href="/m5" class="rounded-lg border border-slate-600 bg-slate-900/80 px-4 py-2 text-sm font-semibold text-sky-200 transition hover:border-sky-400">What is M5 and why it matters?</a>
      </div>
    </div>
  </section>

  <section class="mt-4 grid gap-4 md:grid-cols-3">
    <article class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
      <h3 class="font-semibold">1) Ingest</h3>
      <p class="mt-1 text-sm text-slate-300">Paste one payload with multi-series data. Keep it compact and deterministic.</p>
    </article>
    <article class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
      <h3 class="font-semibold">2) Evaluate</h3>
      <p class="mt-1 text-sm text-slate-300">Run rolling backtests with AutoARIMA + AutoETS, then compare SMAPE by model/window.</p>
    </article>
    <article class="rounded-xl border border-slate-700 bg-slate-900/60 p-4">
      <h3 class="font-semibold">3) Ship</h3>
      <p class="mt-1 text-sm text-slate-300">Get a permalinked forecast report with per-series charts and backfill diagnostics.</p>
    </article>
  </section>

  <section id="payload-form" class="mt-5 rounded-2xl border border-slate-700 bg-slate-900/70 p-4 md:p-6">
    <h2 class="text-2xl font-semibold">Enter Payload, get Forecasts</h2>
    <p class="mt-1 text-sm text-slate-300">Supply your own payload, or use our M5 demo</p>

    <div class="mt-4 space-y-4">
      <div>
        <div class="grid grid-cols-2 gap-2">
          <button type="button" class="tab active rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm font-medium" id="tab-payload">Supply payload</button>
          <button type="button" class="tab rounded-lg border border-slate-600 bg-slate-900 px-3 py-2 text-sm font-medium" id="tab-test">Run M5 demo</button>
        </div>
        <input id="use_m5" type="hidden" value="false" />
      </div>

      <div>
        <label for="payload" class="block text-sm font-medium text-slate-200 mb-2">Paste JSON Payload below</label>
        <details class="rounded-lg border border-slate-700 bg-slate-900 p-3">
          <summary class="cursor-pointer text-sm font-medium text-sky-300">Payload instructions</summary>
          <div class="mt-3 text-xs md:text-sm text-slate-200 space-y-2">
            <p>⚠️ <strong>Time series are assumed to be continuous at your time granularity.</strong> If they are not, backfill them before submitting.</p>
            <div class="overflow-x-auto">
              <table class="min-w-[760px] w-full border border-slate-700 text-xs">
                <thead class="bg-slate-800">
                  <tr>
                    <th class="p-2 text-left border border-slate-700">Field</th>
                    <th class="p-2 text-left border border-slate-700">Required</th>
                    <th class="p-2 text-left border border-slate-700">Description</th>
                    <th class="p-2 text-left border border-slate-700">Example</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td class="p-2 border border-slate-700"><code>run_name_root</code></td><td class="p-2 border border-slate-700">Yes</td><td class="p-2 border border-slate-700">Base run name; app prepends PST timestamp</td><td class="p-2 border border-slate-700"><code>my-run</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>start_datetime</code></td><td class="p-2 border border-slate-700">Custom</td><td class="p-2 border border-slate-700">First timestamp in ISO format</td><td class="p-2 border border-slate-700"><code>2026-01-01T00:00:00</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>granularity</code></td><td class="p-2 border border-slate-700">Custom</td><td class="p-2 border border-slate-700">Step size between points</td><td class="p-2 border border-slate-700"><code>1d</code>, <code>1h</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>horizon</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Forecast periods after history</td><td class="p-2 border border-slate-700"><code>7</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>model</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Engine selector</td><td class="p-2 border border-slate-700"><code>nixtla</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>seasonal_period</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Season length for ARIMA/ETS</td><td class="p-2 border border-slate-700"><code>7</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>n_series</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Series count hint (M5 sampling)</td><td class="p-2 border border-slate-700"><code>3</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>backtest_windows</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Rolling holdout windows for SMAPE</td><td class="p-2 border border-slate-700"><code>3</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>series_names</code></td><td class="p-2 border border-slate-700">Custom</td><td class="p-2 border border-slate-700">Series IDs (<code>demo_mode_m5</code> reserved)</td><td class="p-2 border border-slate-700"><code>["trend","seasonal","combined"]</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>series</code></td><td class="p-2 border border-slate-700">Custom</td><td class="p-2 border border-slate-700">Single list or list-of-lists</td><td class="p-2 border border-slate-700"><code>[[...],[...],[...]]</code></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>

        <textarea id="payload" class="mt-3 w-full min-h-60 rounded-xl border border-slate-700 bg-slate-950 p-3 font-mono text-sm">{defaultPayload}</textarea>
      </div>

      <div>
        <button id="submit-btn" class="rounded-lg bg-sky-600 px-4 py-2 font-semibold text-white transition hover:bg-sky-500">Forecast It!</button>
        <div id="status" class="mt-2 text-sm text-slate-300"></div>
        <div id="status-list" class="mt-2 space-y-1 text-sm"></div>
      </div>
    </div>
  </section>

  <section class="mt-5 rounded-2xl border border-slate-700 bg-slate-900/70 p-4 md:p-6">
    <h2 class="text-xl font-semibold">All Runs</h2>
    <p class="mt-1 text-sm text-slate-300">Most recent forecast outputs available right now.</p>
    <div class="mt-4 grid gap-3 md:grid-cols-2">
      {runs.map((run) => (
        <article class="rounded-xl border border-slate-700 bg-slate-900/50 p-4 transition hover:border-sky-500/50">
          <h3 class="font-semibold text-sky-300"><a href={run.path}>{run.slug}</a></h3>
          <p class="mt-1 text-xs text-slate-400">{run.backend} · {run.granularity} · horizon {run.horizon}</p>
          <p class="text-xs text-slate-400">history {run.history_points} · forecast {run.forecast_points}</p>
        </article>
      ))}
    </div>
  </section>

  <script type="module">
    const statusEl = document.getElementById('status');
    const statusListEl = document.getElementById('status-list');
    const btn = document.getElementById('submit-btn');
    const payloadTab = document.getElementById('tab-payload');
    const testTab = document.getElementById('tab-test');
    const useM5Input = document.getElementById('use_m5');
    const payloadInput = document.getElementById('payload');
    let customPayloadCache = payloadInput.value;

    const STORAGE_KEY = 'forecastingapi_recent_runs_v1';
    const activeTimers = new Map();

    const loadRuns = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
    };
    const saveRuns = (runs) => localStorage.setItem(STORAGE_KEY, JSON.stringify(runs.slice(0, 12)));

    const renderRuns = (runs) => {
      if (!statusListEl) return;
      if (!runs.length) return (statusListEl.innerHTML = '');

      statusListEl.innerHTML = runs.map((r) => {
        const emoji = r.status === 'completed' ? (r.conclusion === 'success' ? '✅' : '❌') : '⏳';
        const statusText = r.status === 'completed' ? (r.conclusion || 'completed') : (r.status || 'queued');
        const forecastHref = `/forecasts/${r.slug}`;
        const href = r.html_url || r.actions_url || 'https://github.com/bryanwhiting/forecastingapi/actions/workflows/forecast-request.yml';
        if (r.status === 'completed' && r.conclusion === 'success') {
          return `<div class="rounded border border-slate-700 bg-slate-900/50 p-2 text-xs text-slate-300">✅ <code>${r.slug}</code> — success · Your forecast is ready: <a href="${forecastHref}" class="text-emerald-300 underline">${forecastHref}</a>, or refresh this browser · <a href="${href}" target="_blank" rel="noreferrer" class="text-sky-300 underline">run</a></div>`;
        }
        return `<div class="rounded border border-slate-700 bg-slate-900/50 p-2 text-xs text-slate-300">${emoji} <code>${r.slug}</code> — ${statusText} · <a href="${href}" target="_blank" rel="noreferrer" class="text-sky-300 underline">open</a></div>`;
      }).join('');
    };

    const upsertRun = (entry) => {
      const runs = loadRuns();
      const idx = runs.findIndex((r) => r.slug === entry.slug);
      if (idx >= 0) runs[idx] = { ...runs[idx], ...entry };
      else runs.unshift(entry);
      saveRuns(runs);
      renderRuns(runs);
    };

    const pollRun = (slug, statusUrl, actionsUrl) => {
      if (activeTimers.has(slug)) return;
      let tries = 0;
      const maxTries = 60;
      const timer = setInterval(async () => {
        tries += 1;
        try {
          const rs = await fetch(statusUrl);
          const rj = await rs.json();
          if (rj?.found) {
            upsertRun({ slug, status: rj.status, conclusion: rj.conclusion, html_url: rj.html_url, actions_url: actionsUrl, updated_at: rj.updated_at });
            if (rj.status === 'completed') {
              if (rj.conclusion === 'success') {
                statusEl.innerHTML = `✅ Your forecast is ready: <a href="/forecasts/${slug}" class="text-emerald-300 underline">/forecasts/${slug}</a>, or refresh this browser`;
              }
              clearInterval(timer);
              activeTimers.delete(slug);
            }
          } else {
            upsertRun({ slug, status: 'locating', actions_url: actionsUrl });
          }
        } catch {
          upsertRun({ slug, status: 'poll_error', actions_url: actionsUrl });
        }
        if (tries >= maxTries) {
          clearInterval(timer);
          activeTimers.delete(slug);
        }
      }, 6000);
      activeTimers.set(slug, timer);
    };

    const setMode = (useM5) => {
      useM5Input.value = String(useM5);
      payloadTab.classList.toggle('active', !useM5);
      testTab.classList.toggle('active', useM5);
      payloadTab.classList.toggle('bg-slate-800', !useM5);
      payloadTab.classList.toggle('bg-slate-900', useM5);
      testTab.classList.toggle('bg-slate-800', useM5);
      testTab.classList.toggle('bg-slate-900', !useM5);
      if (useM5) {
        customPayloadCache = payloadInput.value;
        payloadInput.value = JSON.stringify({ start_datetime: '2026-01-01T00:00:00', granularity: '1d', horizon: 24, model: 'nixtla', seasonal_period: 7, run_name_root: 'demo-m5-test', n_series: 3, backtest_windows: 3, series_names: ['demo_mode_m5'], series: [] }, null, 2);
        payloadInput.readOnly = true;
        payloadInput.style.opacity = '0.65';
      } else {
        payloadInput.readOnly = false;
        payloadInput.style.opacity = '1';
        if (customPayloadCache?.trim()) payloadInput.value = customPayloadCache;
      }
    };

    payloadTab?.addEventListener('click', () => setMode(false));
    testTab?.addEventListener('click', () => setMode(true));

    const existing = loadRuns();
    renderRuns(existing);
    existing.filter((r) => r.status && r.status !== 'completed').forEach((r) => {
      const statusUrl = r.status_url || `/api/run-status?slug=${encodeURIComponent(r.slug)}`;
      pollRun(r.slug, statusUrl, r.actions_url);
    });

    btn?.addEventListener('click', async () => {
      try {
        statusEl.textContent = 'Submitting...';
        btn.disabled = true;
        const use_m5 = document.getElementById('use_m5').value === 'true';
        const payloadRaw = document.getElementById('payload').value;
        const parsedPayload = JSON.parse(payloadRaw || '{}');
        const runNameRoot = String(parsedPayload?.run_name_root || '').trim();
        if (!runNameRoot) throw new Error('payload.run_name_root is required');

        const body = {
          repo: 'bryanwhiting/forecastingapi',
          run_name_root: runNameRoot,
          use_m5,
          payload: payloadRaw,
          backtest_windows: Number(parsedPayload?.backtest_windows ?? 3),
        };

        const res = await fetch('/api/dispatch', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const json = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(json?.error || `Request failed (${res.status})`);

        const link = json?.actions_url || 'https://github.com/bryanwhiting/forecastingapi/actions/workflows/forecast-request.yml';
        const statusUrl = json?.status_url || `/api/run-status?slug=${encodeURIComponent(json?.slug || '')}`;
        const slug = json?.slug || 'run';

        statusEl.innerHTML = `✅ Dispatched as <code>${slug}</code> · <a href="${link}" target="_blank" rel="noreferrer" class="text-sky-300 underline">View GitHub Action</a>`;

        upsertRun({ slug, status: 'queued', actions_url: link, status_url: statusUrl });
        pollRun(slug, statusUrl, link);
      } catch (err) {
        statusEl.textContent = `❌ ${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</MainLayout>
