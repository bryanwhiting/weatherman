---
import MainLayout from '../layouts/MainLayout.astro';
import Navbar from '../components/Navbar.astro';

const forecastModules = import.meta.glob('../data/forecasts/*.json', { eager: true });
const forecastData = Object.values(forecastModules).map((mod: any) => mod.default ?? mod);
const runs = forecastData
  .map((d: any) => ({
    slug: d?.meta?.slug || d?.request?.run_name_root || 'run',
    title: d?.meta?.slug || d?.request?.run_name_root || 'run',
    backend: d?.backend || 'nixtla',
    granularity: d?.request?.granularity || 'n/a',
    horizon: d?.request?.horizon ?? 'n/a',
    history_points: (d?.history || []).length,
    forecast_points: (d?.forecast || []).length,
    created_at: d?.meta?.created_at || '',
    path: `/forecasts/${d?.meta?.slug || d?.request?.run_name_root || 'run'}`,
  }))
  .sort((a, b) => String(b.created_at).localeCompare(String(a.created_at)));

const allBacktests = forecastData.flatMap((data: any) => data.backtest ?? []);

const leaderboardMap = new Map<string, { total: number; count: number }>();
for (const row of allBacktests) {
  const model = row.model;
  const smape = Number(row.smape);
  if (!model || Number.isNaN(smape)) continue;
  const current = leaderboardMap.get(model) ?? { total: 0, count: 0 };
  leaderboardMap.set(model, { total: current.total + smape, count: current.count + 1 });
}

const leaderboard = Array.from(leaderboardMap.entries())
  .map(([model, stats]) => ({ model, avgSmape: stats.total / stats.count, samples: stats.count }))
  .sort((a, b) => a.avgSmape - b.avgSmape);


const defaultPayload = JSON.stringify({
  start_datetime: '2026-01-01T00:00:00',
  granularity: '1d',
  horizon: 7,
  model: 'nixtla',
  run_name_root: 'my-forecast-run',
  n_series: 3,
  backtest_windows: 3,
  series_names: ['trend', 'seasonal', 'combined'],
  series: [
    [100, 102, 104, 106, 108, 110, 112, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 144, 146, 148, 150, 152, 154, 156, 158, 160, 162, 164, 166, 168, 170, 172, 174, 176, 178, 180, 182, 184, 186, 188, 190, 192, 194, 196],
    [13, 18, 25, 17, 9, 14, 22, 12, 18, 25, 17, 9, 14, 22, 13, 18, 25, 17, 9, 14, 22, 12, 18, 25, 17, 9, 14, 22, 13, 18, 25, 17, 9, 14, 22, 12, 18, 25, 17, 9, 14, 22, 13, 18, 25, 17, 9, 14, 22],
    [113, 120, 129, 123, 117, 124, 134, 126, 134, 143, 137, 131, 138, 148, 141, 148, 157, 151, 145, 152, 162, 154, 162, 171, 165, 159, 166, 176, 169, 176, 185, 179, 173, 180, 190, 182, 190, 199, 193, 187, 194, 204, 197, 204, 213, 207, 201, 208, 218]
  ],
}, null, 2);
---
<MainLayout title="Weatherman">
  <Navbar />
  <p class="text-slate-400 mt-1">Forecast requests submitted via GitHub Actions. Click any run for full report.</p>

  <section class="mt-4 rounded-xl border border-slate-700 bg-slate-900/70 p-4">
    <h2 class="text-xl font-semibold mb-2">Submit Forecast Run</h2>

    <div class="space-y-3">
      <div>
        <label class="block text-sm text-slate-300 mb-1">Supply a payload, or run a test</label>
        <div class="grid grid-cols-2 gap-2">
          <button type="button" class="tab active rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm font-medium" id="tab-payload">Supply payload</button>
          <button type="button" class="tab rounded-lg border border-slate-600 bg-slate-900 px-3 py-2 text-sm font-medium" id="tab-test">Run M5 test</button>
        </div>
        <input id="use_m5" type="hidden" value="false" />
      </div>

      <div>
        <label for="payload" class="block text-sm text-slate-300 mb-1">Payload JSON</label>
        <details class="rounded-lg border border-slate-700 bg-slate-900 p-2 mb-2">
          <summary class="cursor-pointer text-sm text-sky-300">Payload instructions</summary>
          <div class="mt-2 text-xs md:text-sm text-slate-200 space-y-2">
            <p>⚠️ <strong>Time series are assumed to be continuous at your time granularity!</strong> If not, backfill them.</p>
            <ul class="list-disc ml-5 space-y-1">
              <li>Payload is JSON only.</li>
              <li>For custom runs, provide values in <code>series</code>.</li>
              <li>For M5 test mode, use <code>series_names: ["demo_mode_m5"]</code> and <code>series: []</code>.</li>
            </ul>
            <div class="overflow-x-auto">
              <table class="min-w-[680px] text-xs border border-slate-700">
                <thead class="bg-slate-800"><tr><th class="p-2 border border-slate-700 text-left">Field</th><th class="p-2 border border-slate-700 text-left">Required</th><th class="p-2 border border-slate-700 text-left">Description</th><th class="p-2 border border-slate-700 text-left">Example</th></tr></thead>
                <tbody>
                  <tr><td class="p-2 border border-slate-700"><code>run_name_root</code></td><td class="p-2 border border-slate-700">Yes</td><td class="p-2 border border-slate-700">Base run name; backend prepends PST timestamp</td><td class="p-2 border border-slate-700"><code>my-run</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>start_datetime</code></td><td class="p-2 border border-slate-700">Custom mode</td><td class="p-2 border border-slate-700">First timestamp for the series (ISO)</td><td class="p-2 border border-slate-700"><code>2026-01-01T17:15:00</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>granularity</code></td><td class="p-2 border border-slate-700">Custom mode</td><td class="p-2 border border-slate-700">Time spacing between points</td><td class="p-2 border border-slate-700"><code>1h</code>, <code>1d</code>, <code>15m</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>horizon</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Forecast periods to predict after history</td><td class="p-2 border border-slate-700"><code>24</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>model</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Forecast backend</td><td class="p-2 border border-slate-700"><code>nixtla</code>, <code>autogluon</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>n_series</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Series count hint (used for M5 demo sampling)</td><td class="p-2 border border-slate-700"><code>3</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>backtest_windows</code></td><td class="p-2 border border-slate-700">No</td><td class="p-2 border border-slate-700">Rolling holdout window count for SMAPE backtests</td><td class="p-2 border border-slate-700"><code>3</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>series_names</code></td><td class="p-2 border border-slate-700">Custom mode</td><td class="p-2 border border-slate-700">List of names for each series (<code>demo_mode_m5</code> reserved for demo)</td><td class="p-2 border border-slate-700"><code>["trend","seasonal","combined"]</code></td></tr>
                  <tr><td class="p-2 border border-slate-700"><code>series</code></td><td class="p-2 border border-slate-700">Custom mode</td><td class="p-2 border border-slate-700">Data values. Single list or list-of-lists (continuous, no gaps)</td><td class="p-2 border border-slate-700"><code>[[...],[...],[...]]</code></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>
        <textarea id="payload" class="w-full min-h-52 rounded-lg border border-slate-700 bg-slate-950 p-3 font-mono text-sm">{defaultPayload}</textarea>
      </div>

      <div>
        <button id="submit-btn" class="rounded-lg bg-sky-700 hover:bg-sky-600 px-4 py-2 font-semibold">Submit run</button>
        <div id="status" class="mt-2 text-sm text-slate-300"></div>
        <div id="status-list" class="mt-2 space-y-1 text-sm"></div>
      </div>
    </div>
  </section>

  {leaderboard.length > 0 && (
    <section class="mt-4 rounded-xl border border-slate-700 bg-slate-900/70 p-4 overflow-x-auto">
      <h2 class="text-lg font-semibold mb-2">Leaderboard (avg SMAPE)</h2>
      <table class="min-w-[420px] text-sm w-full">
        <thead><tr class="text-slate-300"><th class="text-left p-2">Rank</th><th class="text-left p-2">Model</th><th class="text-left p-2">Avg SMAPE</th><th class="text-left p-2">Samples</th></tr></thead>
        <tbody>
          {leaderboard.map((row, idx) => (
            <tr>
              <td class="p-2">{idx + 1}</td><td class={`p-2 ${idx===0?'text-emerald-400 font-semibold':''}`}>{row.model}</td><td class="p-2">{row.avgSmape.toFixed(4)}</td><td class="p-2">{row.samples}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </section>
  )}

  <section class="mt-4 grid gap-3">
    {runs.map((run) => (
      <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-4">
        <h3 class="font-semibold text-sky-300"><a href={run.path}>{run.slug ?? run.title}</a></h3>
        <p class="text-sm text-slate-400 mt-1">{run.backend} · {run.granularity} · horizon {run.horizon} · history {run.history_points} · forecast {run.forecast_points}</p>
      </article>
    ))}
  </section>

  <script type="module">
    const statusEl = document.getElementById('status');
    const statusListEl = document.getElementById('status-list');
    const btn = document.getElementById('submit-btn');
    const payloadTab = document.getElementById('tab-payload');
    const testTab = document.getElementById('tab-test');
    const useM5Input = document.getElementById('use_m5');
    const payloadInput = document.getElementById('payload');
    let customPayloadCache = payloadInput.value;

    const STORAGE_KEY = 'weatherman_recent_runs_v1';
    const activeTimers = new Map();

    const loadRuns = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
    };
    const saveRuns = (runs) => localStorage.setItem(STORAGE_KEY, JSON.stringify(runs.slice(0, 12)));

    const renderRuns = (runs) => {
      if (!statusListEl) return;
      if (!runs.length) {
        statusListEl.innerHTML = '';
        return;
      }
      statusListEl.innerHTML = runs.map((r) => {
        const emoji = r.status === 'completed' ? (r.conclusion === 'success' ? '✅' : '❌') : '⏳';
        const statusText = r.status === 'completed' ? (r.conclusion || 'completed') : (r.status || 'queued');
        const href = r.html_url || r.actions_url || 'https://github.com/bryanwhiting/weatherman/actions/workflows/forecast-request.yml';
        return `<div class="rounded border border-slate-700 bg-slate-900/50 p-2 text-xs text-slate-300">${emoji} <code>${r.slug}</code> — ${statusText} · <a href="${href}" target="_blank" rel="noreferrer" class="text-sky-300 underline">open</a></div>`;
      }).join('');
    };

    const upsertRun = (entry) => {
      const runs = loadRuns();
      const idx = runs.findIndex((r) => r.slug === entry.slug);
      if (idx >= 0) runs[idx] = { ...runs[idx], ...entry };
      else runs.unshift(entry);
      saveRuns(runs);
      renderRuns(runs);
    };

    const pollRun = (slug, statusUrl, actionsUrl) => {
      if (activeTimers.has(slug)) return;
      let tries = 0;
      const maxTries = 60; // ~6 minutes
      const timer = setInterval(async () => {
        tries += 1;
        try {
          const rs = await fetch(statusUrl);
          const rj = await rs.json();
          if (rj?.found) {
            upsertRun({
              slug,
              status: rj.status,
              conclusion: rj.conclusion,
              html_url: rj.html_url,
              actions_url: actionsUrl,
              updated_at: rj.updated_at,
            });
            if (rj.status === 'completed') {
              clearInterval(timer);
              activeTimers.delete(slug);
            }
          } else {
            upsertRun({ slug, status: 'locating', actions_url: actionsUrl });
          }
        } catch {
          upsertRun({ slug, status: 'poll_error', actions_url: actionsUrl });
        }
        if (tries >= maxTries) {
          clearInterval(timer);
          activeTimers.delete(slug);
        }
      }, 6000);
      activeTimers.set(slug, timer);
    };

    const setMode = (useM5) => {
      useM5Input.value = String(useM5);
      payloadTab.classList.toggle('active', !useM5);
      testTab.classList.toggle('active', useM5);
      payloadTab.classList.toggle('bg-slate-800', !useM5); payloadTab.classList.toggle('bg-slate-900', useM5);
      testTab.classList.toggle('bg-slate-800', useM5); testTab.classList.toggle('bg-slate-900', !useM5);
      if (useM5) {
        customPayloadCache = payloadInput.value;
        payloadInput.value = JSON.stringify({ start_datetime: '2026-01-01T00:00:00', granularity: '1d', horizon: 24, model: 'nixtla', run_name_root: 'demo-m5-test', n_series: 3, backtest_windows: 3, series_names: ['demo_mode_m5'], series: [] }, null, 2);
        payloadInput.readOnly = true;
        payloadInput.style.opacity = '0.65';
      } else {
        payloadInput.readOnly = false;
        payloadInput.style.opacity = '1';
        if (customPayloadCache?.trim()) payloadInput.value = customPayloadCache;
      }
    };

    payloadTab?.addEventListener('click', () => setMode(false));
    testTab?.addEventListener('click', () => setMode(true));

    // Restore prior run statuses on load
    const existing = loadRuns();
    renderRuns(existing);
    existing.filter((r) => r.status && r.status !== 'completed').forEach((r) => {
      const statusUrl = r.status_url || `/api/run-status?slug=${encodeURIComponent(r.slug)}`;
      pollRun(r.slug, statusUrl, r.actions_url);
    });

    btn?.addEventListener('click', async () => {
      try {
        statusEl.textContent = 'Submitting...';
        btn.disabled = true;
        const use_m5 = document.getElementById('use_m5').value === 'true';
        const payloadRaw = document.getElementById('payload').value;
        const parsedPayload = JSON.parse(payloadRaw || '{}');
        const runNameRoot = String(parsedPayload?.run_name_root || '').trim();
        if (!runNameRoot) throw new Error('payload.run_name_root is required');

        const body = {
          repo: 'bryanwhiting/weatherman',
          run_name_root: runNameRoot,
          use_m5,
          payload: payloadRaw,
          backtest_windows: Number(parsedPayload?.backtest_windows ?? 3),
        };

        const res = await fetch('/api/dispatch', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const json = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(json?.error || `Request failed (${res.status})`);

        const link = json?.actions_url || 'https://github.com/bryanwhiting/weatherman/actions/workflows/forecast-request.yml';
        const statusUrl = json?.status_url || `/api/run-status?slug=${encodeURIComponent(json?.slug || '')}`;
        const slug = json?.slug || 'run';

        statusEl.innerHTML = `✅ Dispatched as <code>${slug}</code> · <a href="${link}" target="_blank" rel="noreferrer" class="text-sky-300 underline">View GitHub Action</a>`;

        upsertRun({ slug, status: 'queued', actions_url: link, status_url: statusUrl });
        pollRun(slug, statusUrl, link);
      } catch (err) {
        statusEl.textContent = `❌ ${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</MainLayout>
