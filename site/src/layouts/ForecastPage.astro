---
const { data } = Astro.props;
const history = data.history ?? [];
const forecast = data.forecast ?? [];
const backtest = data.backtest ?? [];
const models = [...new Set(forecast.map((r) => r.model))];
const points = [...history.map((r) => ({ ...r, type: 'actual' })), ...forecast.map((r) => ({ ...r, type: 'forecast' }))];
---
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Forecast</title>
    <style>
      body { font-family: Inter, system-ui, sans-serif; padding: 24px; max-width: 1080px; margin: auto; }
      .meta { color: #666; margin-bottom: 10px; }
      canvas { width: 100%; height: 420px; }
      pre { background:#f7f7f7; padding: 12px; border-radius: 8px; overflow:auto; }
      table { border-collapse: collapse; width: 100%; max-width: 480px; margin: 12px 0 20px; }
      th, td { border: 1px solid #ddd; padding: 8px 10px; text-align: left; }
      th { background: #f8f8f8; }
    </style>
  </head>
  <body>
    <h1>Forecast: {data.request.series_name}</h1>
    <p class="meta">Backend: {data.backend} · Granularity: {data.request.granularity} · Horizon: {data.request.horizon} · M5: {String(Boolean(data.request.use_m5))}</p>
    {data?.meta?.github?.run_url && <p class="meta"><a href={data.meta.github.run_url} target="_blank" rel="noreferrer">GitHub action run ↗</a></p>}

    <h2>Actual vs Forecast</h2>
    <canvas id="chart"></canvas>

    {backtest.length > 0 && (
      <>
        <h2>Backtest (last {data.request.horizon} points holdout)</h2>
        <table>
          <thead>
            <tr><th>Model</th><th>SMAPE</th><th>Horizon</th></tr>
          </thead>
          <tbody>
            {backtest.map((row) => (
              <tr>
                <td>{row.model}</td>
                <td>{row.smape}</td>
                <td>{row.horizon}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </>
    )}

    <h2>Request</h2>
    <pre>{JSON.stringify(data.request, null, 2)}</pre>

    <script type="module" define:vars={{ points, models }}>
      import Chart from 'chart.js/auto';

      const allLabels = [...new Set(points.map((p) => new Date(p.ds).toISOString()))].sort();
      const labelFmt = allLabels.map((x) => new Date(x).toLocaleString());
      const pointMap = new Map(points.map((p) => [`${new Date(p.ds).toISOString()}|${p.type}|${p.model ?? ''}`, p]));

      const datasets = [
        {
          label: 'Actual',
          data: allLabels.map((l) => pointMap.get(`${l}|actual|`)?.y ?? null),
          borderColor: '#1d4ed8',
          spanGaps: true,
        },
      ];

      const colors = ['#dc2626', '#16a34a', '#7c3aed', '#ea580c', '#0891b2'];
      models.forEach((m, idx) => {
        datasets.push({
          label: `Forecast (${m})`,
          data: allLabels.map((l) => pointMap.get(`${l}|forecast|${m}`)?.yhat ?? null),
          borderColor: colors[idx % colors.length],
          borderDash: [6, 3],
          spanGaps: true,
        });
      });

      new Chart(document.getElementById('chart'), {
        type: 'line',
        data: { labels: labelFmt, datasets },
        options: { responsive: true, maintainAspectRatio: false }
      });
    </script>
  </body>
</html>
